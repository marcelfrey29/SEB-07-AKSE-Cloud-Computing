# GitLab Documentation
# https://docs.gitlab.com/ee/ci/yaml/

# Stages (executed in the order they are defined: build, test, deploy)
stages:
  - setup
  - build
  - test
  - deploy

# Variables
variables:
  FRONTEND_NODE_MODULES_PATH: "frontend/npm"
  FRONTEND_DIST_FOLDER_PATH: "frontend/dist/"

# Base Rules (other jobs can extend / inherit from this rule)
.base:
  timeout: 60 minutes

.frontend-base:
  extends: .base
  variables:
    RULES_CHANGE_PATH: "todo-frontend/**/*"
  image: "node:16-alpine"
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - $FRONTEND_NODE_MODULES_PATH
      - $FRONTEND_DIST_FOLDER_PATH
#  before_script:
#    - echo $PATH
#    - export PATH="$PATH:$FRONTEND_NODE_MODULES_PATH/.bin"
#    - echo $PATH
#    - echo "Setup PATH"

# Frontend
setup-frontend:
  extends: .frontend-base
  stage: setup
  needs: [ ]
  script:
    - cd todo-frontend
    - npm ci --cache $FRONTEND_NODE_MODULES_PATH --prefer-offline
    - echo "Installed Dependencies."

build-frontend:
  extends: .frontend-base
  stage: build
  needs:
    - setup-frontend
  script:
    - cd todo-frontend
    - PATH="$PATH:$FRONTEND_NODE_MODULES_PATH/.bin" npm run generate
    - echo "Build complete."
    - cp -r dist/ $FRONTEND_DIST_FOLDER_PATH
    - echo "Cached Build Artefacts."

test-frontend-unit:
  extends: .frontend-base
  stage: test
  needs:
    - build-frontend
  script:
    - cd todo-frontend
    - PATH="$PATH:$FRONTEND_NODE_MODULES_PATH/.bin" npm run test
    - echo "Unit Tests complete."

test-frontend-style-prettier:
  extends: .frontend-base
  stage: test
  needs:
    - build-frontend
  script:
    - cd todo-frontend
    - PATH="$PATH:$FRONTEND_NODE_MODULES_PATH/.bin" npm run lint:check:style
    - echo "Prettier Checks complete."

test-frontend-style-eslint:
  extends: .frontend-base
  stage: test
  needs:
    - build-frontend
  script:
    - cd todo-frontend
    - PATH="$PATH:$FRONTEND_NODE_MODULES_PATH/.bin" npm run lint:check:js
    - echo "ESLint Checks complete."

deploy-frontend:
  extends: .frontend-base
  stage: deploy
  needs:
    - test-frontend-unit
    - test-frontend-style-prettier
    - test-frontend-style-eslint
  #when: manual
  script:
    - cd todo-frontend
    - echo "TODO - Deploy..."
    - cd $FRONTEND_DIST_FOLDER_PATH
    - ls -la
    - cat index.html
    - echo "Deploy complete."
